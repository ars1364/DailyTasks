---
- name: Create DNF proxy repositories in Nexus
  hosts: localhost
  gather_facts: no
  vars:
    nexus_url: "https://artifact.cloudinative.com"
    nexus_user: "admin"
    nexus_password: "Cl0ud1n@t1ve!Nxs2026"
    repositories:
      - name: "almalinux-baseos"
        remote_url: "https://repo.almalinux.org/almalinux/9/BaseOS/x86_64/os/"
      - name: "almalinux-appstream"
        remote_url: "https://repo.almalinux.org/almalinux/9/AppStream/x86_64/os/"
      - name: "epel-9"
        remote_url: "https://dl.fedoraproject.org/pub/epel/9/Everything/x86_64/"

  tasks:
    - name: Create YUM proxy repositories
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/yum/proxy"
        method: POST
        user: "{{ nexus_user }}"
        password: "{{ nexus_password }}"
        force_basic_auth: yes
        body_format: json
        body:
          name: "{{ item.name }}"
          online: true
          storage:
            blobStoreName: "default"
            strictContentTypeValidation: false
          proxy:
            remoteUrl: "{{ item.remote_url }}"
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
            connection:
              retries: 0
              userAgentSuffix: "string"
              timeout: 60
              enableCircularRedirects: false
              enableCookies: false
              useTrustStore: false
          routingRule: "string"
          replication:
            preemptivePullEnabled: false
            assetPathRegex: "string"
        headers:
          Content-Type: "application/json"
        status_code: [201, 400]
      loop: "{{ repositories }}"
      register: repo_creation
      
    - name: Display repository creation results
      debug:
        msg: "Repository {{ item.item.name }}: {{ 'Created' if item.status == 201 else 'Already exists or failed' }}"
      loop: "{{ repo_creation.results }}"