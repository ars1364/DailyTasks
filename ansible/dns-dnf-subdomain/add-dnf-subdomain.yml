---
- name: Add dnf.cloudinative.com DNS record
  hosts: dns-server
  gather_facts: yes
  become: yes
  vars:
    zone_file: "/etc/bind/zones/db.cloudinative.com"
    dns_record: "dnf		IN	A	176.65.243.214"
    
  tasks:
    - name: Check if dnf record already exists
      shell: grep -q "^dnf" {{ zone_file }}
      register: dns_check
      failed_when: false
      changed_when: false

    - name: Add dnf.cloudinative.com A record
      lineinfile:
        path: "{{ zone_file }}"
        line: "{{ dns_record }}"
        insertafter: "^www.*IN.*A.*"
        state: present
      when: dns_check.rc != 0
      notify: reload bind9

    - name: Increment zone serial number
      replace:
        path: "{{ zone_file }}"
        regexp: '(\d{10})(\s+;\s*serial)'
        replace: '{{ ansible_date_time.epoch }}{{ "\2" }}'
      notify: reload bind9

  handlers:
    - name: reload bind9
      service:
        name: bind9
        state: reloaded