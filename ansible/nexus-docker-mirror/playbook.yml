---
# Nexus Docker Mirror Setup
# Creates Nexus repos, uploads GPG key + install script, configures nginx
#
# Usage:
#   ansible-playbook playbook.yml -i inventory.yml
#   # Or override nexus password:
#   NEXUS_ADMIN_PASSWORD=secret ansible-playbook playbook.yml -i inventory.yml

- name: Setup Docker CE mirror on Nexus
  hosts: artifact
  become: false
  vars_files:
    - vars.yml

  tasks:
    # ── Step 1: Create docker-ce raw proxy repo ──────────────────────
    - name: Check if docker-ce repo exists
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/raw/proxy/{{ docker_ce_repo }}"
        method: GET
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        status_code: [200, 404]
      register: docker_ce_check

    - name: Create docker-ce raw proxy repository
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/raw/proxy"
        method: POST
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        body_format: json
        body:
          name: "{{ docker_ce_repo }}"
          online: true
          storage:
            blobStoreName: default
            strictContentTypeValidation: false
          proxy:
            remoteUrl: "{{ docker_upstream_url }}"
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
        status_code: 201
      when: docker_ce_check.status == 404

    # ── Step 2: Create docker-gpg raw hosted repo ────────────────────
    - name: Check if docker-gpg repo exists
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/raw/hosted/{{ docker_gpg_repo }}"
        method: GET
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        status_code: [200, 404]
      register: docker_gpg_check

    - name: Create docker-gpg raw hosted repository
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/raw/hosted"
        method: POST
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        body_format: json
        body:
          name: "{{ docker_gpg_repo }}"
          online: true
          storage:
            blobStoreName: default
            strictContentTypeValidation: false
            writePolicy: ALLOW
        status_code: 201
      when: docker_gpg_check.status == 404

    # ── Step 3: Download and upload Docker GPG key ───────────────────
    - name: Download Docker GPG key
      get_url:
        url: "{{ docker_upstream_url }}/linux/ubuntu/gpg"
        dest: /tmp/docker.gpg
        mode: '0644'

    - name: Upload Docker GPG key to Nexus
      uri:
        url: "{{ nexus_url }}/repository/{{ docker_gpg_repo }}/docker.gpg"
        method: PUT
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        src: /tmp/docker.gpg
        headers:
          Content-Type: application/octet-stream
        status_code: [201, 400]
        # 400 = already exists, which is fine

    # ── Step 4: Download, patch, and upload install script ───────────
    - name: Download official get-docker.sh
      get_url:
        url: "https://get.docker.com"
        dest: /tmp/get-docker-original.sh
        mode: '0644'

    - name: Patch install script to use local mirror
      copy:
        content: "{{ lookup('file', '/tmp/get-docker-original.sh') | regex_replace('DEFAULT_DOWNLOAD_URL=\"https://download.docker.com\"', 'DEFAULT_DOWNLOAD_URL=\"' + mirror_base_url + '\"') }}"
        dest: /tmp/get-docker.sh
        mode: '0644'
      delegate_to: localhost
      become: false

    - name: Copy patched script to artifact
      copy:
        src: /tmp/get-docker.sh
        dest: /tmp/get-docker.sh
        mode: '0644'

    - name: Upload install script to Nexus
      uri:
        url: "{{ nexus_url }}/repository/{{ docker_gpg_repo }}/get-docker.sh"
        method: PUT
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        src: /tmp/get-docker.sh
        headers:
          Content-Type: text/plain
        status_code: [201, 400]

    # ── Step 5: Update anonymous role with new repo privileges ───────
    - name: Get current anonymous role
      uri:
        url: "{{ nexus_url }}/service/rest/v1/security/roles/{{ anonymous_role_id }}"
        method: GET
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        return_content: true
      register: anon_role

    - name: Build updated privilege list
      set_fact:
        updated_privileges: >-
          {{ anon_role.json.privileges | union([
            'nx-repository-view-raw-' + docker_ce_repo + '-read',
            'nx-repository-view-raw-' + docker_ce_repo + '-browse',
            'nx-repository-view-raw-' + docker_gpg_repo + '-read',
            'nx-repository-view-raw-' + docker_gpg_repo + '-browse'
          ]) }}

    - name: Update anonymous role with new privileges
      uri:
        url: "{{ nexus_url }}/service/rest/v1/security/roles/{{ anonymous_role_id }}"
        method: PUT
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        body_format: json
        body:
          id: "{{ anon_role.json.id }}"
          name: "{{ anon_role.json.name }}"
          description: "{{ anon_role.json.description }}"
          privileges: "{{ updated_privileges }}"
          roles: "{{ anon_role.json.roles }}"
        status_code: 204
      when: updated_privileges | length > anon_role.json.privileges | length

    # ── Step 6: Update nginx config ──────────────────────────────────
    - name: Check if docker-ce nginx location already exists
      command: grep -c 'repository/docker-ce' {{ nginx_conf_path }}
      register: nginx_docker_check
      ignore_errors: true
      changed_when: false

    - name: Add docker-ce and docker-gpg nginx locations
      become: true
      blockinfile:
        path: "{{ nginx_conf_path }}"
        insertbefore: "location / \\{\\s*\n\\s*return 200"
        marker: "        # {mark} ANSIBLE MANAGED - Docker CE Mirror"
        block: |2
                  location /repository/docker-ce/ {
                      proxy_pass http://127.0.0.1:8081/repository/docker-ce/;
                      proxy_read_timeout 600;
                      proxy_buffering off;
                  }

                  location /repository/docker-gpg/ {
                      proxy_pass http://127.0.0.1:8081/repository/docker-gpg/;
                      proxy_read_timeout 600;
                      proxy_buffering off;
                  }
      when: nginx_docker_check.rc != 0 or nginx_docker_check.stdout == "0"
      notify: reload nginx

    - name: Update repo list in catch-all response
      become: true
      replace:
        path: "{{ nginx_conf_path }}"
        regexp: '"repos":\s*\[([^\]]*)\]'
        replace: '"repos": ["ubuntu", "ubuntu-security", "kubernetes", "docker-ce", "docker-gpg"]'
      notify: reload nginx

    # ── Step 7: Verify ───────────────────────────────────────────────
    - name: Verify GPG key accessible
      uri:
        url: "{{ nexus_url }}/repository/{{ docker_gpg_repo }}/docker.gpg"
        method: GET
        status_code: 200
      register: gpg_verify

    - name: Verify install script accessible
      uri:
        url: "{{ nexus_url }}/repository/{{ docker_gpg_repo }}/get-docker.sh"
        method: GET
        status_code: 200
      register: script_verify

    - name: Verify docker-ce proxy works
      uri:
        url: "{{ nexus_url }}/repository/{{ docker_ce_repo }}/linux/ubuntu/gpg"
        method: GET
        status_code: 200
      register: proxy_verify

    - name: Print verification results
      debug:
        msg: |
          ✓ GPG key: {{ gpg_verify.content_length }} bytes
          ✓ Install script: {{ script_verify.content_length }} bytes
          ✓ Docker CE proxy: {{ proxy_verify.content_length }} bytes
          
          Install command for end users:
            curl -fsSL https://apt.cloudinative.com/repository/docker-gpg/get-docker.sh | bash

  handlers:
    - name: reload nginx
      become: true
      service:
        name: nginx
        state: reloaded
