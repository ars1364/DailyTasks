---
# Nexus Artifact Mirror Setup
# Configures Nexus as a clean mirror for Ubuntu APT, Docker CE, and Docker Registry.
#
# Clean URL mapping (users just swap the domain, path stays the same):
#   archive.ubuntu.com/ubuntu/       -> archive.cloudinative.com/ubuntu/
#   security.ubuntu.com/ubuntu/      -> security.cloudinative.com/ubuntu/
#   download.docker.com/linux/ubuntu -> download.cloudinative.com/linux/ubuntu
#   registry-1.docker.io             -> docker.cloudinative.com
#
# Usage:
#   ansible-playbook playbook.yml -i inventory.yml
#   # Or override nexus password:
#   NEXUS_ADMIN_PASSWORD=secret ansible-playbook playbook.yml -i inventory.yml

- name: Setup clean artifact mirrors on Nexus
  hosts: artifact
  become: false
  vars_files:
    - vars.yml

  tasks:
    # ════════════════════════════════════════════════════════════════
    # NEXUS REPOSITORIES
    # ════════════════════════════════════════════════════════════════

    # ── Ubuntu APT proxy ─────────────────────────────────────────
    - name: Check if ubuntu-proxy repo exists
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/apt/proxy/{{ ubuntu_proxy_repo }}"
        method: GET
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        status_code: [200, 404]
      register: ubuntu_check

    - name: Create ubuntu-proxy APT repository
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/apt/proxy"
        method: POST
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        body_format: json
        body:
          name: "{{ ubuntu_proxy_repo }}"
          online: true
          storage:
            blobStoreName: default
            strictContentTypeValidation: true
          proxy:
            remoteUrl: "{{ ubuntu_upstream_url }}"
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          apt:
            distribution: noble
            flat: false
        status_code: 201
      when: ubuntu_check.status == 404

    # ── Ubuntu Security APT proxy ────────────────────────────────
    - name: Check if ubuntu-security-proxy repo exists
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/apt/proxy/{{ ubuntu_security_proxy_repo }}"
        method: GET
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        status_code: [200, 404]
      register: ubuntu_sec_check

    - name: Create ubuntu-security-proxy APT repository
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/apt/proxy"
        method: POST
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        body_format: json
        body:
          name: "{{ ubuntu_security_proxy_repo }}"
          online: true
          storage:
            blobStoreName: default
            strictContentTypeValidation: true
          proxy:
            remoteUrl: "{{ ubuntu_security_upstream_url }}"
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
          apt:
            distribution: noble-security
            flat: false
        status_code: 201
      when: ubuntu_sec_check.status == 404

    # ── Docker CE raw proxy ──────────────────────────────────────
    - name: Check if docker-ce repo exists
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/raw/proxy/{{ docker_ce_repo }}"
        method: GET
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        status_code: [200, 404]
      register: docker_ce_check

    - name: Create docker-ce raw proxy repository
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/raw/proxy"
        method: POST
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        body_format: json
        body:
          name: "{{ docker_ce_repo }}"
          online: true
          storage:
            blobStoreName: default
            strictContentTypeValidation: false
          proxy:
            remoteUrl: "{{ docker_upstream_url }}"
            contentMaxAge: 1440
            metadataMaxAge: 1440
          negativeCache:
            enabled: true
            timeToLive: 1440
          httpClient:
            blocked: false
            autoBlock: true
        status_code: 201
      when: docker_ce_check.status == 404

    # ── Docker GPG raw hosted ────────────────────────────────────
    - name: Check if docker-gpg repo exists
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/raw/hosted/{{ docker_gpg_repo }}"
        method: GET
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        status_code: [200, 404]
      register: docker_gpg_check

    - name: Create docker-gpg raw hosted repository
      uri:
        url: "{{ nexus_url }}/service/rest/v1/repositories/raw/hosted"
        method: POST
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        body_format: json
        body:
          name: "{{ docker_gpg_repo }}"
          online: true
          storage:
            blobStoreName: default
            strictContentTypeValidation: false
            writePolicy: ALLOW
        status_code: 201
      when: docker_gpg_check.status == 404

    # ════════════════════════════════════════════════════════════════
    # GPG KEY & INSTALL SCRIPT
    # ════════════════════════════════════════════════════════════════

    - name: Download Docker GPG key
      get_url:
        url: "{{ docker_upstream_url }}/linux/ubuntu/gpg"
        dest: /tmp/docker.gpg
        mode: '0644'

    - name: Upload Docker GPG key to Nexus
      uri:
        url: "{{ nexus_url }}/repository/{{ docker_gpg_repo }}/docker.gpg"
        method: PUT
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        src: /tmp/docker.gpg
        headers:
          Content-Type: application/octet-stream
        status_code: [201, 400]

    - name: Download official get-docker.sh
      get_url:
        url: "https://get.docker.com"
        dest: /tmp/get-docker-original.sh
        mode: '0644'

    - name: Patch install script to use local mirror
      copy:
        content: "{{ lookup('file', '/tmp/get-docker-original.sh') | regex_replace('DEFAULT_DOWNLOAD_URL=\"https://download.docker.com\"', 'DEFAULT_DOWNLOAD_URL=\"https://download.' + mirror_domain + '\"') }}"
        dest: /tmp/get-docker.sh
        mode: '0644'
      delegate_to: localhost
      become: false

    - name: Copy patched script to artifact
      copy:
        src: /tmp/get-docker.sh
        dest: /tmp/get-docker.sh
        mode: '0644'

    - name: Upload install script to Nexus
      uri:
        url: "{{ nexus_url }}/repository/{{ docker_gpg_repo }}/get-docker.sh"
        method: PUT
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        src: /tmp/get-docker.sh
        headers:
          Content-Type: text/plain
        status_code: [201, 400]

    # ════════════════════════════════════════════════════════════════
    # ANONYMOUS ACCESS
    # ════════════════════════════════════════════════════════════════

    - name: Get current anonymous role
      uri:
        url: "{{ nexus_url }}/service/rest/v1/security/roles/{{ anonymous_role_id }}"
        method: GET
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        return_content: true
      register: anon_role

    - name: Build updated privilege list
      set_fact:
        updated_privileges: >-
          {{ anon_role.json.privileges | union([
            'nx-repository-view-raw-' + docker_ce_repo + '-read',
            'nx-repository-view-raw-' + docker_ce_repo + '-browse',
            'nx-repository-view-raw-' + docker_gpg_repo + '-read',
            'nx-repository-view-raw-' + docker_gpg_repo + '-browse',
            'nx-repository-view-apt-' + ubuntu_proxy_repo + '-read',
            'nx-repository-view-apt-' + ubuntu_proxy_repo + '-browse',
            'nx-repository-view-apt-' + ubuntu_security_proxy_repo + '-read',
            'nx-repository-view-apt-' + ubuntu_security_proxy_repo + '-browse'
          ]) }}

    - name: Update anonymous role with new privileges
      uri:
        url: "{{ nexus_url }}/service/rest/v1/security/roles/{{ anonymous_role_id }}"
        method: PUT
        user: "{{ nexus_admin_user }}"
        password: "{{ nexus_admin_password }}"
        force_basic_auth: true
        body_format: json
        body:
          id: "{{ anon_role.json.id }}"
          name: "{{ anon_role.json.name }}"
          description: "{{ anon_role.json.description }}"
          privileges: "{{ updated_privileges }}"
          roles: "{{ anon_role.json.roles }}"
        status_code: 204
      when: updated_privileges | length > anon_role.json.privileges | length

    # ════════════════════════════════════════════════════════════════
    # NGINX (artifact VM)
    # ════════════════════════════════════════════════════════════════

    - name: Deploy artifact nginx config
      become: true
      template:
        src: templates/nginx-mirrors.conf.j2
        dest: "{{ nginx_conf_path }}"
        backup: true
      notify: reload nginx

    # ════════════════════════════════════════════════════════════════
    # VERIFY
    # ════════════════════════════════════════════════════════════════

    - name: Verify Ubuntu APT proxy
      uri:
        url: "{{ nexus_url }}/repository/{{ ubuntu_proxy_repo }}/dists/noble/InRelease"
        method: GET
        status_code: 200
      register: ubuntu_verify

    - name: Verify Ubuntu Security APT proxy
      uri:
        url: "{{ nexus_url }}/repository/{{ ubuntu_security_proxy_repo }}/dists/noble-security/InRelease"
        method: GET
        status_code: 200
      register: ubuntu_sec_verify

    - name: Verify Docker CE proxy
      uri:
        url: "{{ nexus_url }}/repository/{{ docker_ce_repo }}/linux/ubuntu/gpg"
        method: GET
        status_code: 200
      register: docker_verify

    - name: Print verification results
      debug:
        msg: |
          All mirrors verified successfully.

          Clean URL mapping (just swap the domain):
            archive.ubuntu.com   -> archive.{{ mirror_domain }}
            security.ubuntu.com  -> security.{{ mirror_domain }}
            download.docker.com  -> download.{{ mirror_domain }}
            registry-1.docker.io -> docker.{{ mirror_domain }}

          Quick Docker install:
            curl -fsSL https://download.{{ mirror_domain }}/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.asc
            echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.{{ mirror_domain }}/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
            sudo apt-get update && sudo apt-get install -y docker-ce docker-ce-cli containerd.io

  handlers:
    - name: reload nginx
      become: true
      service:
        name: nginx
        state: reloaded
