---
- name: Configure AlmaLinux VM to use internal DNF and Docker mirrors
  hosts: almalinux_vms
  become: yes
  vars:
    internal_mirror_domain: "dnf.cloudinative.com"
    docker_mirror_domain: "docker.cloudinative.com"
    
  tasks:
    - name: Backup existing repository files
      shell: |
        mkdir -p /etc/yum.repos.d.backup
        cp /etc/yum.repos.d/*.repo /etc/yum.repos.d.backup/ || true
      
    - name: Remove all existing repository files
      shell: rm -f /etc/yum.repos.d/*.repo
      
    - name: Create AlmaLinux BaseOS repository
      copy:
        content: |
          [baseos]
          name=AlmaLinux $releasever - BaseOS
          baseurl=http://{{ internal_mirror_domain }}/almalinux-baseos/
          enabled=1
          gpgcheck=1
          countme=1
          gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux-9
        dest: /etc/yum.repos.d/almalinux-baseos.repo
        
    - name: Create AlmaLinux AppStream repository
      copy:
        content: |
          [appstream]
          name=AlmaLinux $releasever - AppStream
          baseurl=http://{{ internal_mirror_domain }}/almalinux-appstream/
          enabled=1
          gpgcheck=1
          countme=1
          gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux-9
        dest: /etc/yum.repos.d/almalinux-appstream.repo
        
    - name: Create EPEL repository
      copy:
        content: |
          [epel]
          name=Extra Packages for Enterprise Linux 9 - $basearch
          baseurl=http://{{ internal_mirror_domain }}/epel-proxy/9/Everything/$basearch/
          enabled=1
          gpgcheck=1
          countme=1
          gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-9
        dest: /etc/yum.repos.d/epel.repo
        
    - name: Install EPEL GPG key
      rpm_key:
        key: https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-9
        state: present
      ignore_errors: yes
      
    - name: Clean DNF cache
      command: dnf clean all
      
    - name: Update package cache
      dnf:
        update_cache: yes
        
    - name: Install required packages via internal mirror
      dnf:
        name:
          - docker-ce
          - postgresql
          - nginx
          - redis
        state: present
      register: package_install
      
    - name: Create Docker daemon directory
      file:
        path: /etc/docker
        state: directory
        
    - name: Configure Docker to use internal mirror
      copy:
        content: |
          {
            "registry-mirrors": ["https://{{ docker_mirror_domain }}"],
            "insecure-registries": ["{{ docker_mirror_domain }}"]
          }
        dest: /etc/docker/daemon.json
        
    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
        
    - name: Test Docker pull from internal mirror
      command: docker pull {{ docker_mirror_domain }}/postgresql:latest
      register: docker_pull_test
      ignore_errors: yes
      
    - name: Verify all packages installed from internal mirror
      shell: |
        dnf history | head -10
        echo "=== Verifying repository usage ==="
        grep -r "cloudinative.com" /etc/yum.repos.d/
      register: verification_output
      
    - name: Display verification results
      debug:
        var: verification_output.stdout_lines
        
  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted